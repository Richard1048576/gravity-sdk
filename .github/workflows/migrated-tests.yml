name: Migrated Tests

on:
  push:
    branches: [main, 'branch-v**']
  pull_request:
    branches: [main, 'branch-v**']
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: "0"
  RUSTFLAGS: "--cfg tokio_unstable"

# Cancel redundant builds on PRs
concurrency:
  group: ${{ github.workflow }}-${{ (github.event_name == 'pull_request' && github.ref) || github.sha }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Migrated Consensus Tests - Tests from gaptos that have been validated
  # ==========================================================================

  test-consensus-types:
    name: Test Consensus Types (11 tests)
    runs-on: ubuntu-latest
    container:
      image: rust:1.88.0-bookworm
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            clang llvm libudev-dev libssl-dev pkg-config \
          && rm -rf /var/lib/apt/lists/*
      - name: Run cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "test-consensus-types"
      - name: Run consensus-types tests
        run: cargo test --manifest-path aptos-core/consensus/consensus-types/Cargo.toml --no-fail-fast

  test-safety-rules:
    name: Test Safety Rules (10 tests)
    runs-on: ubuntu-latest
    container:
      image: rust:1.88.0-bookworm
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            clang llvm libudev-dev libssl-dev pkg-config \
          && rm -rf /var/lib/apt/lists/*
      - name: Run cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "test-safety-rules"
      - name: Run safety-rules tests (skip hanging thread test)
        run: cargo test --manifest-path aptos-core/consensus/safety-rules/Cargo.toml --no-fail-fast -- --skip tests::thread --test-threads=1

  test-mempool:
    name: Test Mempool (1 test)
    runs-on: ubuntu-latest
    container:
      image: rust:1.88.0-bookworm
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            clang llvm libudev-dev libssl-dev pkg-config \
          && rm -rf /var/lib/apt/lists/*
      - name: Run cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "test-mempool"
      - name: Run mempool tests
        run: cargo test --manifest-path aptos-core/mempool/Cargo.toml --no-fail-fast

  test-dag:
    name: Test DAG (19 tests)
    runs-on: ubuntu-latest
    container:
      image: rust:1.88.0-bookworm
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            clang llvm libudev-dev libssl-dev pkg-config \
          && rm -rf /var/lib/apt/lists/*
      - name: Run cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "test-dag"
      - name: Run DAG tests (skip E2E which requires more infrastructure)
        run: cargo test --manifest-path aptos-core/consensus/Cargo.toml "dag::tests::" --no-fail-fast -- --skip integration_tests::test_dag_e2e --test-threads=1

  test-network:
    name: Test Network (4 tests)
    runs-on: ubuntu-latest
    container:
      image: rust:1.88.0-bookworm
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            clang llvm libudev-dev libssl-dev pkg-config \
          && rm -rf /var/lib/apt/lists/*
      - name: Run cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "test-network"
      - name: Run network tests
        run: cargo test --manifest-path aptos-core/consensus/Cargo.toml "network_tests::" --no-fail-fast

  # Aggregate results - all tests must pass
  migrated-test-results:
    name: All Migrated Tests (45 tests)
    runs-on: ubuntu-latest
    needs: [test-consensus-types, test-safety-rules, test-mempool, test-dag, test-network]
    if: always()
    steps:
      - name: Check test results
        run: |
          echo "=== Migrated Test Results ==="
          echo "consensus-types (11): ${{ needs.test-consensus-types.result }}"
          echo "safety-rules (10): ${{ needs.test-safety-rules.result }}"
          echo "mempool (1): ${{ needs.test-mempool.result }}"
          echo "dag (19): ${{ needs.test-dag.result }}"
          echo "network (4): ${{ needs.test-network.result }}"
          echo ""
          echo "Total: 45 tests"

          # All tests must pass
          if [ "${{ needs.test-consensus-types.result }}" != "success" ] || \
             [ "${{ needs.test-safety-rules.result }}" != "success" ] || \
             [ "${{ needs.test-mempool.result }}" != "success" ] || \
             [ "${{ needs.test-dag.result }}" != "success" ] || \
             [ "${{ needs.test-network.result }}" != "success" ]; then
            echo "Some tests failed!"
            exit 1
          fi

          echo "All 45 migrated tests passed!"
