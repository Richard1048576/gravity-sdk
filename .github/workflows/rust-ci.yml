name: Rust CI

on:
  push:
    branches: [main, 'branch-v**']
  pull_request:
    branches: [main, 'branch-v**']
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: "0"
  RUSTFLAGS: "--cfg tokio_unstable"

# Cancel redundant builds on PRs
concurrency:
  group: ${{ github.workflow }}-${{ (github.event_name == 'pull_request' && github.ref) || github.sha }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Format check - lightweight, runs directly on runner
  # ==========================================================================
  fmt:
    name: Rust Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install nightly rustfmt
        run: rustup toolchain install nightly --component rustfmt
      - name: Check formatting
        run: cargo +nightly fmt --all -- --check

  # ==========================================================================
  # Clippy - uses pre-built image with cached dependencies
  # ==========================================================================
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/galxe/gravity-sdk/rust-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Restore cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "clippy-v1"
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  # ==========================================================================
  # Build - uses pre-built image
  # ==========================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/galxe/gravity-sdk/rust-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Restore cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "build-v1"
      - name: Build gravity_node
        run: cargo build --bin gravity_node --profile quick-release
      - name: Build gravity_cli
        run: cargo build --bin gravity_cli --profile quick-release

  # ==========================================================================
  # Unit Tests - MERGED into single job to avoid redundant compilation
  # Compile once, run all tests sequentially
  # ==========================================================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/galxe/gravity-sdk/rust-ci:latest
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'CICD:run-tests')
    steps:
      - uses: actions/checkout@v4

      - name: Restore cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "test-v1"
          # Cache the entire target directory for test builds
          cache-targets: "true"

      - name: Show disk space
        run: df -h

      # ========== Build all tests first (compile once) ==========
      - name: Build all tests
        run: cargo build --tests --workspace --exclude smoke-test

      - name: Show disk space after build
        run: df -h

      # ========== Run tests by group ==========
      - name: Run core crate tests
        run: |
          echo "::group::gravity-primitives"
          cargo test -p gravity-primitives --no-fail-fast
          echo "::endgroup::"
          echo "::group::gravity-storage"
          cargo test -p gravity-storage --no-fail-fast
          echo "::endgroup::"
          echo "::group::api"
          cargo test -p api --no-fail-fast
          echo "::endgroup::"
          echo "::group::api-types"
          cargo test -p api-types --no-fail-fast
          echo "::endgroup::"

      - name: Run consensus tests
        run: |
          echo "::group::block-buffer-manager"
          cargo test -p block-buffer-manager --no-fail-fast
          echo "::endgroup::"
          echo "::group::txn_metrics"
          cargo test -p txn_metrics --no-fail-fast
          echo "::endgroup::"

      - name: Run gaptos tests
        run: |
          echo "::group::gaptos"
          cargo test -p gaptos --no-fail-fast
          echo "::endgroup::"

      - name: Run aptos-consensus tests (validated subset - 45 tests)
        run: |
          echo "::group::consensus-types (11 tests)"
          cargo test --manifest-path aptos-core/consensus/consensus-types/Cargo.toml --no-fail-fast
          echo "::endgroup::"
          echo "::group::safety-rules (10 tests)"
          cargo test --manifest-path aptos-core/consensus/safety-rules/Cargo.toml --no-fail-fast -- --skip tests::thread --test-threads=1
          echo "::endgroup::"
          echo "::group::mempool (1 test)"
          cargo test --manifest-path aptos-core/mempool/Cargo.toml --no-fail-fast
          echo "::endgroup::"
          echo "::group::DAG tests (19 tests)"
          cargo test --manifest-path aptos-core/consensus/Cargo.toml "dag::tests::" --no-fail-fast -- --skip integration_tests::test_dag_e2e --test-threads=1
          echo "::endgroup::"
          echo "::group::network tests (4 tests)"
          cargo test --manifest-path aptos-core/consensus/Cargo.toml "network_tests::" --no-fail-fast
          echo "::endgroup::"

      - name: Run aptos-executor tests
        run: |
          echo "::group::aptos-executor"
          cargo test --manifest-path dependencies/aptos-executor/Cargo.toml --no-fail-fast -- --test-threads=1
          echo "::endgroup::"

      - name: Run binary tests
        run: |
          echo "::group::gravity_node"
          cargo test -p gravity_node --no-fail-fast -- --test-threads=1
          echo "::endgroup::"
          echo "::group::gravity_cli"
          cargo test -p gravity_cli --no-fail-fast
          echo "::endgroup::"

      - name: Show final disk space
        run: df -h

  # ==========================================================================
  # Dependency checks
  # ==========================================================================
  dependency-check:
    name: Check gravity-reth Dependency
    runs-on: ubuntu-latest
    if: startsWith(github.ref_name, 'branch-v')
    steps:
      - uses: actions/checkout@v4
      - name: Check gravity-reth branch dependency
        run: |
          set -e

          VERSION=$(echo "${{ github.ref_name }}" | sed 's/^branch-//')
          EXPECTED_BRANCH="gravity-devnet-${VERSION}"

          echo "===== Dependency Check ====="
          echo "Current branch: ${{ github.ref_name }}"
          echo "Expected gravity-reth branch: ${EXPECTED_BRANCH}"
          echo "============================="

          CARGO_FILE="bin/gravity_node/Cargo.toml"

          if [ ! -f "${CARGO_FILE}" ]; then
            echo "ERROR: ${CARGO_FILE} not found"
            exit 1
          fi

          if grep -q 'greth = .*branch = "' "${CARGO_FILE}"; then
            ACTUAL_BRANCH=$(grep 'greth = ' "${CARGO_FILE}" | sed -n 's/.*branch = "\([^"]*\)".*/\1/p')

            echo "Current greth dependency branch: ${ACTUAL_BRANCH}"

            if [ "${ACTUAL_BRANCH}" != "${EXPECTED_BRANCH}" ]; then
              echo ""
              echo "ERROR: greth dependency branch mismatch!"
              echo "  Expected: ${EXPECTED_BRANCH}"
              echo "  Actual:   ${ACTUAL_BRANCH}"
              echo ""
              echo "Please update ${CARGO_FILE} to use:"
              echo '  greth = { git = "https://github.com/Galxe/gravity-reth", branch = "'${EXPECTED_BRANCH}'" }'
              exit 1
            fi
          else
            echo "ERROR: greth dependency must use 'branch' parameter"
            echo ""
            echo "Current greth dependency line:"
            grep 'greth = ' "${CARGO_FILE}"
            echo ""
            echo "Please update it to use branch format:"
            echo '  greth = { git = "https://github.com/Galxe/gravity-reth", branch = "'${EXPECTED_BRANCH}'" }'
            exit 1
          fi

          echo ""
          echo "âœ“ Dependency check PASSED"
          echo "  Using gravity-reth branch: ${EXPECTED_BRANCH}"
