name: Rust CI

on:
  push:
    branches: [main, 'branch-v**']
  pull_request:
    branches: [main, 'branch-v**']
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: "0"
  RUSTFLAGS: "--cfg tokio_unstable"

# NOTE: Using rust:1.88.0-bookworm with runtime dependency installation
# After merging to main, switch to ghcr.io/galxe/gravity-sdk/rust-ci:latest (custom image with pre-installed deps)

# Cancel redundant builds on PRs
concurrency:
  group: ${{ github.workflow }}-${{ (github.event_name == 'pull_request' && github.ref) || github.sha }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Lightweight jobs - run directly on runner (fast, no container overhead)
  # ==========================================================================

  fmt:
    name: Rust Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install nightly rustfmt
        run: rustup toolchain install nightly --component rustfmt
      - name: Check formatting
        run: cargo +nightly fmt --all -- --check

  # ==========================================================================
  # Heavyweight jobs - run in container (clean environment, more disk space)
  # ==========================================================================

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    container:
      image: rust:1.88.0-bookworm
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            clang llvm libudev-dev libssl-dev pkg-config \
          && rm -rf /var/lib/apt/lists/*
      - name: Run cargo cache
        uses: Swatinem/rust-cache@v2
      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  build:
    name: Build
    runs-on: ubuntu-latest
    container:
      image: rust:1.88.0-bookworm
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            clang llvm libudev-dev libssl-dev pkg-config \
          && rm -rf /var/lib/apt/lists/*
      - name: Run cargo cache
        uses: Swatinem/rust-cache@v2
      - name: Build gravity_node
        run: cargo build --bin gravity_node --profile quick-release
      - name: Build gravity_cli
        run: cargo build --bin gravity_cli --profile quick-release

  # ==========================================================================
  # Unit Tests - Split into parallel jobs, run in containers
  # ==========================================================================

  test-core:
    name: Test Core Crates
    runs-on: ubuntu-latest
    container:
      image: rust:1.88.0-bookworm
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'CICD:run-tests')
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            clang llvm libudev-dev libssl-dev pkg-config \
          && rm -rf /var/lib/apt/lists/*
      - name: Run cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "test-core"
      - name: Run core tests
        run: |
          cargo test -p gravity-primitives --no-fail-fast
          cargo test -p gravity-storage --no-fail-fast
          cargo test -p api --no-fail-fast
          cargo test -p api-types --no-fail-fast

  test-consensus:
    name: Test Consensus
    runs-on: ubuntu-latest
    container:
      image: rust:1.88.0-bookworm
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'CICD:run-tests')
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            clang llvm libudev-dev libssl-dev pkg-config \
          && rm -rf /var/lib/apt/lists/*
      - name: Run cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "test-consensus"
      - name: Run consensus tests
        run: |
          cargo test -p block-buffer-manager --no-fail-fast
          cargo test -p txn_metrics --no-fail-fast

  test-aptos:
    name: Test Aptos Crates
    runs-on: ubuntu-latest
    container:
      image: rust:1.88.0-bookworm
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'CICD:run-tests')
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            clang llvm libudev-dev libssl-dev pkg-config \
          && rm -rf /var/lib/apt/lists/*
      - name: Run cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "test-aptos"
      - name: Show disk space
        run: df -h
      - name: Run aptos-consensus tests (validated subset - 45 tests)
        run: |
          # Run consensus-types tests (11 tests)
          cargo test --manifest-path aptos-core/consensus/consensus-types/Cargo.toml --no-fail-fast
          # Run safety-rules tests (10 tests, skip hanging thread test)
          cargo test --manifest-path aptos-core/consensus/safety-rules/Cargo.toml --no-fail-fast -- --skip tests::thread --test-threads=1
          # Run mempool tests (1 test)
          cargo test --manifest-path aptos-core/mempool/Cargo.toml --no-fail-fast
          # Run DAG tests (19 tests, skip E2E which requires more infrastructure)
          cargo test --manifest-path aptos-core/consensus/Cargo.toml "dag::tests::" --no-fail-fast -- --skip integration_tests::test_dag_e2e --test-threads=1
          # Run network tests (4 tests)
          cargo test --manifest-path aptos-core/consensus/Cargo.toml "network_tests::" --no-fail-fast
      - name: Clean intermediate artifacts
        run: cargo clean --manifest-path aptos-core/consensus/Cargo.toml
      - name: Run aptos-executor tests (serial)
        run: cargo test --manifest-path dependencies/aptos-executor/Cargo.toml --no-fail-fast -- --test-threads=1

  test-dependencies:
    name: Test Dependencies
    runs-on: ubuntu-latest
    container:
      image: rust:1.88.0-bookworm
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'CICD:run-tests')
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            clang llvm libudev-dev libssl-dev pkg-config \
          && rm -rf /var/lib/apt/lists/*
      - name: Run cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "test-deps"
      - name: Run dependency tests
        run: cargo test -p gaptos --no-fail-fast

  test-binaries:
    name: Test Binaries
    runs-on: ubuntu-latest
    container:
      image: rust:1.88.0-bookworm
    needs: [test-core, test-consensus]
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'CICD:run-tests')
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          apt-get update && apt-get install -y --no-install-recommends \
            clang llvm libudev-dev libssl-dev pkg-config \
          && rm -rf /var/lib/apt/lists/*
      - name: Run cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "test-binaries"
      - name: Show disk space
        run: df -h
      - name: Run gravity_node tests (serial)
        run: cargo test -p gravity_node --no-fail-fast -- --test-threads=1
      - name: Clean to free space
        run: |
          cargo clean -p gravity_node
          df -h
      - name: Run gravity_cli tests
        run: cargo test -p gravity_cli --no-fail-fast

  # Aggregate test results
  test-results:
    name: All Tests
    runs-on: ubuntu-latest
    needs: [test-core, test-consensus, test-aptos, test-dependencies, test-binaries]
    if: always()
    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.test-core.result }}" != "success" ] || \
             [ "${{ needs.test-consensus.result }}" != "success" ] || \
             [ "${{ needs.test-aptos.result }}" != "success" ] || \
             [ "${{ needs.test-dependencies.result }}" != "success" ] || \
             [ "${{ needs.test-binaries.result }}" != "success" ]; then
            echo "One or more test jobs failed"
            exit 1
          fi
          echo "All tests passed!"

  # ==========================================================================
  # Dependency checks
  # ==========================================================================

  dependency-check:
    name: Check gravity-reth Dependency
    runs-on: ubuntu-latest
    if: startsWith(github.ref_name, 'branch-v')
    steps:
      - uses: actions/checkout@v4
      - name: Check gravity-reth branch dependency
        run: |
          set -e

          VERSION=$(echo "${{ github.ref_name }}" | sed 's/^branch-//')
          EXPECTED_BRANCH="gravity-devnet-${VERSION}"

          echo "===== Dependency Check ====="
          echo "Current branch: ${{ github.ref_name }}"
          echo "Expected gravity-reth branch: ${EXPECTED_BRANCH}"
          echo "============================="

          CARGO_FILE="bin/gravity_node/Cargo.toml"

          if [ ! -f "${CARGO_FILE}" ]; then
            echo "ERROR: ${CARGO_FILE} not found"
            exit 1
          fi

          if grep -q 'greth = .*branch = "' "${CARGO_FILE}"; then
            ACTUAL_BRANCH=$(grep 'greth = ' "${CARGO_FILE}" | sed -n 's/.*branch = "\([^"]*\)".*/\1/p')

            echo "Current greth dependency branch: ${ACTUAL_BRANCH}"

            if [ "${ACTUAL_BRANCH}" != "${EXPECTED_BRANCH}" ]; then
              echo ""
              echo "ERROR: greth dependency branch mismatch!"
              echo "  Expected: ${EXPECTED_BRANCH}"
              echo "  Actual:   ${ACTUAL_BRANCH}"
              echo ""
              echo "Please update ${CARGO_FILE} to use:"
              echo '  greth = { git = "https://github.com/Galxe/gravity-reth", branch = "'${EXPECTED_BRANCH}'" }'
              exit 1
            fi
          else
            echo "ERROR: greth dependency must use 'branch' parameter"
            echo ""
            echo "Current greth dependency line:"
            grep 'greth = ' "${CARGO_FILE}"
            echo ""
            echo "Please update it to use branch format:"
            echo '  greth = { git = "https://github.com/Galxe/gravity-reth", branch = "'${EXPECTED_BRANCH}'" }'
            exit 1
          fi

          echo ""
          echo "âœ“ Dependency check PASSED"
          echo "  Using gravity-reth branch: ${EXPECTED_BRANCH}"
