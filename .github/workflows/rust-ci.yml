name: Rust CI

on:
  push:
    branches: [main, 'branch-v**']
  pull_request:
    branches: [main, 'branch-v**']
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: "0"
  RUSTFLAGS: "--cfg tokio_unstable"

# Cancel redundant builds on PRs
concurrency:
  group: ${{ github.workflow }}-${{ (github.event_name == 'pull_request' && github.ref) || github.sha }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Format check - lightweight, runs directly on runner
  # ==========================================================================
  fmt:
    name: Rust Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install nightly rustfmt
        run: rustup toolchain install nightly --component rustfmt
      - name: Check formatting
        run: cargo +nightly fmt --all -- --check

  # ==========================================================================
  # Clippy - lint check (uses Docker container with pre-installed tools)
  # ==========================================================================
  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    env:
      CI_IMAGE: ghcr.io/richard1048576/gravity-sdk/rust-ci:latest
    steps:
      - name: Free disk space
        run: |
          echo "=== Initial disk space ==="
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost /usr/share/swift /usr/local/graalvm
          echo "=== After cleanup ==="
          df -h

      - uses: actions/checkout@v4

      - name: Pull CI image
        run: docker pull $CI_IMAGE

      - name: Restore cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target-cache
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-clippy-

      - name: Run clippy in container
        run: |
          # Copy cached target if exists
          if [ -d "target-cache" ]; then
            cp -rn target-cache target 2>/dev/null || true
          fi
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e CARGO_TERM_COLOR=always \
            -e CARGO_INCREMENTAL=0 \
            -e RUSTFLAGS="--cfg tokio_unstable" \
            $CI_IMAGE \
            bash -c "cp -rn /opt/target-cache target 2>/dev/null || true; cargo clippy --profile ci --all-targets --all-features -- -D warnings"

      - name: Save cargo cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target-cache
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}

  # ==========================================================================
  # Build - verify release binaries compile (uses Docker container)
  # ==========================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    env:
      CI_IMAGE: ghcr.io/richard1048576/gravity-sdk/rust-ci:latest
    steps:
      - name: Free disk space
        run: |
          echo "=== Initial disk space ==="
          df -h
          # Remove large unnecessary packages (~25GB total)
          sudo rm -rf /usr/share/dotnet              # ~6GB
          sudo rm -rf /usr/local/lib/android         # ~10GB
          sudo rm -rf /opt/ghc                       # ~2GB
          sudo rm -rf /opt/hostedtoolcache/CodeQL    # ~5GB
          sudo rm -rf /usr/local/share/boost         # ~1GB
          sudo rm -rf /usr/share/swift               # ~1.5GB
          sudo rm -rf /usr/local/graalvm/
          sudo rm -rf /usr/local/.ghcup/
          sudo rm -rf /usr/local/share/powershell
          sudo rm -rf /usr/local/share/chromium
          sudo rm -rf /opt/hostedtoolcache/go
          sudo rm -rf /opt/hostedtoolcache/node
          echo "=== After cleanup ==="
          df -h

      - uses: actions/checkout@v4

      - name: Pull CI image
        run: docker pull $CI_IMAGE

      - name: Build binaries in container
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e CARGO_TERM_COLOR=always \
            -e CARGO_INCREMENTAL=0 \
            -e RUSTFLAGS="--cfg tokio_unstable" \
            $CI_IMAGE \
            bash -c "cp -rn /opt/target-cache target 2>/dev/null || true; cargo build --bin gravity_node --profile quick-release && cargo build --bin gravity_cli --profile quick-release"

  # ==========================================================================
  # Build Tests - compile all tests once (uses Docker container)
  # ==========================================================================
  build-tests:
    name: Build Tests
    runs-on: ubuntu-latest
    env:
      CI_IMAGE: ghcr.io/richard1048576/gravity-sdk/rust-ci:latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'CICD:run-tests')
    steps:
      - name: Free disk space
        run: |
          echo "=== Initial disk space ==="
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost /usr/share/swift /usr/local/graalvm
          sudo rm -rf /usr/local/.ghcup/ /usr/local/share/powershell /usr/local/share/chromium
          sudo rm -rf /opt/hostedtoolcache/go /opt/hostedtoolcache/node
          echo "=== After cleanup ==="
          df -h

      - uses: actions/checkout@v4

      - name: Pull CI image
        run: docker pull $CI_IMAGE

      - name: Build all tests
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e CARGO_TERM_COLOR=always \
            -e CARGO_INCREMENTAL=0 \
            -e RUSTFLAGS="--cfg tokio_unstable" \
            $CI_IMAGE \
            bash -c "cp -rn /opt/target-cache target 2>/dev/null || true; cargo build --tests --workspace --exclude smoke-test --profile ci"

      - name: Fix permissions and clean artifacts
        run: |
          # Fix Docker root ownership for upload
          sudo chown -R $(id -u):$(id -g) target/ci
          # Remove incremental and fingerprint to reduce size
          rm -rf target/ci/incremental target/ci/.fingerprint target/ci/build
          du -sh target/ci

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-target
          path: target/ci
          retention-days: 1
          compression-level: 1

  # ==========================================================================
  # Unit Tests - Parallel matrix jobs using pre-built artifacts
  # ==========================================================================
  test:
    name: "Tests (${{ matrix.group }})"
    runs-on: ubuntu-latest
    needs: build-tests
    env:
      CI_IMAGE: ghcr.io/richard1048576/gravity-sdk/rust-ci:latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - group: core
            test_cmd: >-
              cargo test -p api --profile ci --no-fail-fast &&
              cargo test -p gravity-primitives --profile ci --no-fail-fast &&
              cargo test -p gravity-storage --profile ci --no-fail-fast &&
              cargo test -p api-types --profile ci --no-fail-fast
          - group: consensus-core
            test_cmd: >-
              cargo test -p block-buffer-manager --profile ci --no-fail-fast &&
              cargo test -p txn_metrics --profile ci --no-fail-fast &&
              cargo test --manifest-path aptos-core/consensus/consensus-types/Cargo.toml --profile ci --no-fail-fast &&
              cargo test --manifest-path aptos-core/consensus/safety-rules/Cargo.toml --profile ci --no-fail-fast -- --skip tests::thread --test-threads=1
          - group: consensus-dag
            test_cmd: >-
              cargo test --manifest-path aptos-core/consensus/Cargo.toml --profile ci "dag::tests::" --no-fail-fast -- --skip integration_tests::test_dag_e2e --test-threads=1
          - group: consensus-network
            test_cmd: >-
              cargo test --manifest-path aptos-core/mempool/Cargo.toml --profile ci --no-fail-fast &&
              cargo test --manifest-path aptos-core/consensus/Cargo.toml --profile ci "network_tests::" --no-fail-fast
          - group: gaptos
            test_cmd: >-
              cargo test -p gaptos --profile ci --no-fail-fast &&
              cargo test --manifest-path dependencies/aptos-executor/Cargo.toml --profile ci --no-fail-fast -- --test-threads=1
          - group: binaries
            test_cmd: >-
              cargo test -p gravity_node --profile ci --no-fail-fast -- --test-threads=1 &&
              cargo test -p gravity_cli --profile ci --no-fail-fast
    steps:
      - name: Free disk space
        run: |
          echo "=== Initial disk space ==="
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost /usr/share/swift /usr/local/graalvm
          sudo rm -rf /usr/local/.ghcup/ /usr/local/share/powershell /usr/local/share/chromium
          sudo rm -rf /opt/hostedtoolcache/go /opt/hostedtoolcache/node
          echo "=== After cleanup ==="
          df -h

      - uses: actions/checkout@v4

      - name: Download test artifacts
        uses: actions/download-artifact@v4
        with:
          name: test-target
          path: target/ci

      - name: Pull CI image
        run: docker pull $CI_IMAGE

      - name: Run tests
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e CARGO_TERM_COLOR=always \
            -e CARGO_INCREMENTAL=0 \
            -e RUSTFLAGS="--cfg tokio_unstable" \
            $CI_IMAGE \
            bash -c "${{ matrix.test_cmd }}"

      - name: Show final disk space
        run: df -h

  # ==========================================================================
  # Dependency checks for release branches
  # ==========================================================================
  dependency-check:
    name: Check gravity-reth Dependency
    runs-on: ubuntu-latest
    if: startsWith(github.ref_name, 'branch-v')
    steps:
      - uses: actions/checkout@v4
      - name: Check gravity-reth branch dependency
        run: |
          set -e
          VERSION=$(echo "${{ github.ref_name }}" | sed 's/^branch-//')
          EXPECTED_BRANCH="gravity-devnet-${VERSION}"

          echo "===== Dependency Check ====="
          echo "Current branch: ${{ github.ref_name }}"
          echo "Expected gravity-reth branch: ${EXPECTED_BRANCH}"

          CARGO_FILE="bin/gravity_node/Cargo.toml"
          if [ ! -f "${CARGO_FILE}" ]; then
            echo "ERROR: ${CARGO_FILE} not found"
            exit 1
          fi

          if grep -q 'greth = .*branch = "' "${CARGO_FILE}"; then
            ACTUAL_BRANCH=$(grep 'greth = ' "${CARGO_FILE}" | sed -n 's/.*branch = "\([^"]*\)".*/\1/p')
            echo "Current greth dependency branch: ${ACTUAL_BRANCH}"

            if [ "${ACTUAL_BRANCH}" != "${EXPECTED_BRANCH}" ]; then
              echo "ERROR: greth dependency branch mismatch!"
              echo "  Expected: ${EXPECTED_BRANCH}"
              echo "  Actual:   ${ACTUAL_BRANCH}"
              exit 1
            fi
          else
            echo "ERROR: greth dependency must use 'branch' parameter"
            exit 1
          fi

          echo "Dependency check PASSED"
