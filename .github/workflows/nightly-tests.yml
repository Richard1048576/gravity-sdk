name: Nightly Tests (Debug)

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: "0"
  RUSTFLAGS: "--cfg tokio_unstable"

jobs:
  # ==========================================================================
  # Nightly debug mode tests - parallel matrix jobs with Docker container
  # ==========================================================================

  test-all-debug:
    name: "Debug Tests (${{ matrix.group }})"
    runs-on: ubuntu-latest
    env:
      CI_IMAGE: ghcr.io/richard1048576/gravity-sdk/rust-ci:latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - group: core
            test_cmd: >-
              cargo test -p gravity-primitives --no-fail-fast &&
              cargo test -p gravity-storage --no-fail-fast &&
              cargo test -p api --no-fail-fast &&
              cargo test -p api-types --no-fail-fast
          - group: consensus
            test_cmd: >-
              cargo test -p block-buffer-manager --no-fail-fast &&
              cargo test -p txn_metrics --no-fail-fast &&
              cargo test --manifest-path aptos-core/consensus/consensus-types/Cargo.toml --no-fail-fast &&
              cargo test --manifest-path aptos-core/consensus/safety-rules/Cargo.toml --no-fail-fast -- --skip tests::thread --test-threads=1 &&
              cargo test --manifest-path aptos-core/mempool/Cargo.toml --no-fail-fast &&
              cargo test --manifest-path aptos-core/consensus/Cargo.toml "dag::tests::" --no-fail-fast -- --skip integration_tests::test_dag_e2e --test-threads=1 &&
              cargo test --manifest-path aptos-core/consensus/Cargo.toml "network_tests::" --no-fail-fast
          - group: gaptos
            test_cmd: >-
              cargo test -p gaptos --no-fail-fast &&
              cargo test --manifest-path dependencies/aptos-executor/Cargo.toml --no-fail-fast -- --test-threads=1
          - group: binaries
            test_cmd: >-
              cargo test -p gravity_node --no-fail-fast -- --test-threads=1 &&
              cargo test -p gravity_cli --no-fail-fast
    steps:
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost /usr/share/swift /usr/local/graalvm
          sudo rm -rf /usr/local/.ghcup/ /usr/local/share/powershell /usr/local/share/chromium
          sudo rm -rf /opt/hostedtoolcache/go /opt/hostedtoolcache/node
          df -h

      - uses: actions/checkout@v4

      - name: Pull CI image
        run: docker pull $CI_IMAGE

      - name: Build tests
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e CARGO_TERM_COLOR=always \
            -e CARGO_INCREMENTAL=0 \
            -e RUSTFLAGS="--cfg tokio_unstable" \
            $CI_IMAGE \
            bash -c "cp -rn /opt/target-cache target 2>/dev/null || true; cargo build --tests --workspace --exclude smoke-test"

      - name: Clean incremental artifacts
        run: |
          rm -rf target/debug/incremental || true
          df -h

      - name: Run tests
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            -e CARGO_TERM_COLOR=always \
            -e CARGO_INCREMENTAL=0 \
            -e RUSTFLAGS="--cfg tokio_unstable" \
            $CI_IMAGE \
            bash -c "${{ matrix.test_cmd }}"

      - name: Show final disk space
        run: df -h
